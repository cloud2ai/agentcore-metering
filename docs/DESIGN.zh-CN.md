# Agentcore Metering 设计文档（中文）

本文档描述 Agentcore Metering 的设计定位、原则与能力，便于评审与实现对齐。

---

## 一、定位与目标

- **定位**：面向 Django 项目的 **AI 调用与统计统一模块**，提供 LLM 调用的可观测性（用量、成本、配置）。
- **目标**：使用 LiteLLM 统一补全与成本估算；提供配置目录（全局/按用户）、用量记录与统计 API；供 Newshub、Devify、easy-divine、devmind 等项目复用，避免各项目重复实现 LLM 追踪与配置逻辑。

---

## 二、场景与需求

本模块提供的核心能力按**使用场景**分为两类：

- **面向 Django 项目与业务代码（记录侧）**：各项目在代码中通过 **import** 使用本模块（如 `LLMTracker.call_and_track(...)`），实现**记录**功能——调用即落库，无需在环境变量中维护敏感信息，配置由统一入口管理。
- **面向管理员（API 侧）**：通过 HTTP API 主要为**管理员用户**提供**查询、统计**功能——如用量列表、按时间/模型/用户聚合、成本统计、配置管理等；普通业务用户不直接依赖这些 API。

先明确上述场景与需求，再在「提供的核心能力」中展开具体能力。

---

## 三、设计原则

### 1. 可观测性为旁路（observability as side-channel）

- 本模块**只记录**调用与用量，不驱动业务工作流。
- 业务代码通过 `LLMTracker.call_and_track(...)` 发起调用；追踪与落库是**旁路**，业务逻辑与 LiteLLM 是调用的真相源。

### 2. 配置与用量分离

- **配置**：LLM 模型、API、参数等由「配置目录」管理（全局默认 + 可选按用户覆盖），解析顺序：用户作用域 → 全局作用域 → Django settings 回退。
- **用量**：每次调用产生一条用量记录（tokens、cost、model、user 等），用于统计与成本分析；不把配置与用量混在同一张表或同一职责中。

### 3. 成本与币种

- 成本以**金额 + 币种**存储（如 `cost`、`cost_currency`）。
- 默认币种为 USD（与 LiteLLM 一致）；便于后续多币种或本地化展示。

### 4. 统一配置入口（避免敏感信息进环境变量）

- 本模块提供**统一的配置入口**（管理 API + 数据库存储），API Key、api_base 等敏感信息通过配置目录维护，**无需在环境变量中声明**。
- 各环境（开发/预发/生产）或按用户差异的密钥与端点，均可通过配置管理，降低泄露风险与部署复杂度。

---

## 四、提供的核心能力

| 能力 | 说明 |
|------|------|
| **1. LLM 调用与追踪** | `LLMTracker.call_and_track(...)`：使用 LiteLLM 补全，并落库用量（tokens、cost、model、user 等）；可选传入 `state`（含 `user_id`）以按用户配置调用。 |
| **2. 配置目录** | 全局默认配置 + 按用户覆盖；通过**统一配置入口**（管理 API）增删改查，API Key 等敏感信息存库即可，**无需写进环境变量**；解析时按 order 取第一条激活配置（用户 → 全局 → settings）。 |
| **3. 用量记录与统计** | 单次调用写入 `LLMUsage`；提供按时间、按模型、按用户等统计与分页列表 API（如 token-stats、llm-usage）。 |
| **4. 多提供商与模型** | 通过 LiteLLM 支持多提供商；各提供商可配置默认模型、`api_base` 等；成本按 LiteLLM 参考价估算。 |

---

## 五、不做什么

- 不驱动业务流程、不替代业务侧的 prompt/工作流设计。
- 不做计费与账单（仅提供用量与成本数据，计费由业务或上层系统负责）。
- 不提供「按用量自动限流/熔断」策略（可由业务或网关基于本模块数据自行实现）。

---

## 六、与各项目的关系

- **需求一致**：各项目均需要「统一 LLM 调用 + 可配置模型/API + 用量与成本可查」。
- **可替代**：各项目内自建的 LLM 配置与用量记录可由本模块替代；接入时注册 App、挂载 URL、使用 `LLMTracker.call_and_track` 即可。

---

## 七、表结构与存储

- **LLMUsage**：单表存储每次调用的用量（user、model、tokens、cost、cost_currency、success 等）；按标量字段筛选与聚合，满足统计与列表需求。
- **LLM 配置**：配置表存储全局/用户级配置（模型、api_base、参数等）；解析逻辑在服务层，不混入用量表。

---

## 八、相关文档

- 设计文档（英文）：[DESIGN.md](DESIGN.md)  
- 使用说明：[README.zh-CN.md](../README.zh-CN.md) / [README.md](../README.md)

---
